import socket
import asyncio
from pymodbus.server.asyncio import StartTcpServer
from pymodbus.datastore import ModbusSlaveContext, ModbusServerContext

async def run_server():
    hostname = socket.gethostname()
    server_ip_address = socket.gethostbyname(hostname)
    server_port = 502
    store = ModbusSlaveContext(zero_mode=True)
    context = ModbusServerContext(slaves=store, single=True)
    
    server = await StartTcpServer(context, address=(server_ip_address, server_port))
    print("[+]Info : Server Started on IP : {I} and PORT : {P} ".format(I=server_ip_address, P=server_port))
    
    try:
        await server.serve_forever()
    except KeyboardInterrupt:
        print("Server stopped.")
    finally:
        await server.shutdown()
        await server.server_close()

if __name__ == "__main__":
    asyncio.run(run_server())
